# Simple ASR Service –Ω–∞ –±–∞–∑–µ Whisper

–ü—Ä–æ—Å—Ç–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAI Whisper. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API-–∫–ª—é—á–∞–º–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏ Whisper.

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- üéØ –≠–Ω–¥–ø–æ–∏–Ω—Ç `/transcribe` –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
- üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API-–∫–ª—é—á–∞–º–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
- üìä –¢—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞: `json`, `simple`, `text/plain`
- ‚öôÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ `whisper.transcribe()`
- üê≥ Docker –∏ native –∑–∞–ø—É—Å–∫
- üè• Health check —ç–Ω–¥–ø–æ–∏–Ω—Ç
- üîÑ –ì–æ—Ä—è—á–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ API-–∫–ª—é—á–µ–π
- üöÄ GPU —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (NVIDIA/AMD)
- ‚öôÔ∏è –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ .env —Ñ–∞–π–ª

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.8+
- FFmpeg (–¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ)
- –ú–∏–Ω–∏–º—É–º 4GB RAM
- –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –º–æ–¥–µ–ª–µ–π (turbo ~1GB, large ~3GB)
- **GPU —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π CUDA –∏–ª–∏ ROCm (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

–î–ª—è Docker –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- Docker + Docker Compose
- NVIDIA Docker runtime (–¥–ª—è NVIDIA GPU)
- ROCm (–¥–ª—è AMD GPU)

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker

```bash
git clone https://github.com/SlavaVlad/simple-asr-server.git ./asr
cd asr

# –î–ª—è AMD GPU –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å
# –î–ª—è NVIDIA GPU —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–µ–∫—Ü–∏—é –≤ docker-compose.yml

docker compose up -d
```

### –ù–∞—Ç–∏–≤–Ω—ã–π –∑–∞–ø—É—Å–∫

```bash
git clone https://github.com/SlavaVlad/simple-asr-server.git ./asr
cd asr

chmod +x start_server.sh
./start_server.sh
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------------|----------|
| `HOST` | `0.0.0.0` | IP –∞–¥—Ä–µ—Å –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ |
| `PORT` | `9854` | –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ |
| `DEFAULT_MODEL` | `turbo` | –ú–æ–¥–µ–ª—å Whisper –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ |
| `MODEL_DEVICE` | `cuda` | –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: `cuda`, `cpu`, –∏–ª–∏ `auto` |
| `MODEL_DOWNLOAD_ROOT` | `./models` | –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –º–æ–¥–µ–ª–µ–π |
| `KEYS_FILE` | `./data/keys.txt` | –§–∞–π–ª —Å API –∫–ª—é—á–∞–º–∏ |
| `LOG_LEVEL` | `info` | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è |
| `HSA_OVERRIDE_GFX_VERSION` | `10.3.0` | –í–µ—Ä—Å–∏—è GPU –¥–ª—è AMD ROCm |
| `AUDIO_SPEEDUP` | `1.25` | –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ |

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GPU

**–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ—Ä–≤–∏—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å NVIDIA GPU.**

**–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CPU:**
```env
MODEL_DEVICE=cpu
```

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ Whisper

- `tiny` - —Å–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è, –Ω–∞–∏–º–µ–Ω–µ–µ —Ç–æ—á–Ω–∞—è (~40MB)
- `base` - –±–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ (~150MB)
- `small` - —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ (~500MB)
- `medium` - –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ (~1.5GB)
- `large` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (~3GB)
- `turbo` - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (~800MB, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API-–∫–ª—é—á–∞–º–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ:
1. –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `openssl` - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–π 64-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∫–ª—é—á
2. –ï—Å–ª–∏ `openssl` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª –∫–ª—é—á–µ–π

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π

1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `data/keys.txt` (–æ–¥–∏–Ω –∫–ª—é—á –Ω–∞ —Å—Ç—Ä–æ–∫—É, 64 hex —Å–∏–º–≤–æ–ª–∞)
2. –í—ã–∑–æ–≤–∏—Ç–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:

```bash
curl -X POST "http://localhost:9854/keys/reload" \
  -H "X-API-Key: your-api-key"
```

–ü—Ä–∏–º–µ—Ä `data/keys.txt`:
```
key1
key2
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞
openssl rand -hex 32

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª –∫–ª—é—á–µ–π
echo "$(openssl rand -hex 32)" >> data/keys.txt
```

## API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### POST /transcribe

–û—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏.

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ:**
- `audio_file` - –∞—É–¥–∏–æ—Ñ–∞–π–ª (form-data)

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:**
- `format` - —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: `json` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), `simple`, `text`
- –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `whisper.transcribe()`:
  - `language` - —è–∑—ã–∫ –∞—É–¥–∏–æ (auto-detect –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `task` - `transcribe` –∏–ª–∏ `translate`
  - `temperature` - —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (0.0-1.0)
  - `beam_size` - —Ä–∞–∑–º–µ—Ä –ª—É—á–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
  - `best_of` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–≥–æ
  - `compression_ratio_threshold` - –ø–æ—Ä–æ–≥ —Å–∂–∞—Ç–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  - `logprob_threshold` - –ø–æ—Ä–æ–≥ –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
  - `no_speech_threshold` - –ø–æ—Ä–æ–≥ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–µ—á–∏
  - `condition_on_previous_text` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç
  - `initial_prompt` - –Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –º–æ–¥–µ–ª–∏
  - `word_timestamps` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ —Å–ª–æ–≤ (true/false)
  - `prepend_punctuations` - –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –Ω–∞—á–∞–ª–æ
  - `append_punctuations` - –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ–Ω–µ—Ü
  - `clip_timestamps` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ –∞—É–¥–∏–æ
  - `hallucination_silence_threshold` - –ø–æ—Ä–æ–≥ —Ç–∏—à–∏–Ω—ã –¥–ª—è –æ—Ç—Ä–µ–∑–∞–Ω–∏—è –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π

#### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–æ—Å—Ç–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è:**
```bash
curl -X POST "http://localhost:9854/transcribe" \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{}' \
  --form "audio_file=@audio.wav"
```

**–° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:**
```bash
curl -X POST "http://localhost:9854/transcribe" \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "language": "ru",
    "format": "simple",
    "word_timestamps": true,
    "temperature": 0.2
  }' \
  --form "audio_file=@audio.wav"
```

**–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç:**
```bash
curl -X POST "http://localhost:9854/transcribe" \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{"format": "text"}' \
  --form "audio_file=@audio.wav"
```

**–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```bash
curl -X POST "http://localhost:9854/transcribe" \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "language": "en",
    "task": "translate",
    "temperature": 0.1,
    "beam_size": 5,
    "word_timestamps": true,
    "initial_prompt": "This is a technical presentation about AI",
    "format": "json"
  }' \
  --form "audio_file=@audio.wav"
```

#### –§–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤

**json (–ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç Whisper):**
```json
{
  "text": "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?",
  "segments": [
    {
      "start": 0.0,
      "end": 2.5,
      "text": "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?",
      "words": [...]
    }
  ],
  "language": "ru"
}
```

**simple (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç):**
```json
{
  "text": "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"
}
```

**text (plain text):**
```
–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?
```

### GET /health

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞:

```bash
curl "http://localhost:9854/health"
```

–û—Ç–≤–µ—Ç:
```json
{
  "status": "healthy",
  "model_loaded": true,
  "model_name": "turbo"
}
```

## –ö–æ–¥—ã –æ—à–∏–±–æ–∫

- `401` - API –∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω
- `403` - –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á
- `422` - –ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
- `500` - –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞/–º–æ–¥–µ–ª–∏

## Systemd —Å–µ—Ä–≤–∏—Å

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–æ–∑–¥–∞–π—Ç–µ systemd —Å–µ—Ä–≤–∏—Å:

```bash
sudo cp asr.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable asr
sudo systemctl start asr
```

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –∞—É–¥–∏–æ

–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ FFmpeg:
- WAV, MP3, FLAC, M4A, OGG
- –í–∏–¥–µ–æ —Ñ–æ—Ä–º–∞—Ç—ã (–∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∞—É–¥–∏–æ): MP4, AVI, MKV

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:
- –í—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞—É–¥–∏–æ
- –î–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (CPU/GPU)

–ü—Ä–∏–º–µ—Ä–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∞ –¥–ª—è 1 –º–∏–Ω—É—Ç—ã –∞—É–¥–∏–æ:
- `tiny`: ~2-5 —Å–µ–∫—É–Ω–¥
- `turbo`: ~5-10 —Å–µ–∫—É–Ω–¥  
- `large`: ~15-30 —Å–µ–∫—É–Ω–¥
